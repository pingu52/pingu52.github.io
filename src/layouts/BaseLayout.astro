---
import "@/styles/global.css";
import Sidebar from "@/components/Sidebar.astro";
import { getAllPosts } from "@/lib/posts";

const {
  title = "pingu52",
  description = "개발 기록 / 공부 기록 / 포트폴리오",
} = Astro.props;

const allPosts = await getAllPosts();
---

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href="/favicon.svg" />
  </head>
  <body>
    <!--
      Sidebar toggle
      - Desktop(>=861px): default open
      - Mobile(<861px): default closed
      The state is remembered in localStorage.
    -->
    <input id="sidebar-toggle" class="sidebar-toggle" type="checkbox" aria-hidden="true" />

    <header class="topbar">
      <div class="topbar-wrap">
        <!-- Left column aligns with the sidebar width (desktop). -->
        <div class="topbar-left">
          <label class="menu-btn" for="sidebar-toggle" aria-label="메뉴 열기/닫기" role="button">
            <span class="menu-icon" aria-hidden="true"></span>
          </label>
        </div>

        <!-- Main column aligns with the content container. -->
        <div class="topbar-main">
          <div class="topbar-inner">
            <!-- Banner + Home link -->
            <a class="brand" href="/" aria-label="홈으로">
              <span class="brand-mark" aria-hidden="true"></span>
              <span class="brand-text">
                <span class="brand-title">pingu52</span>
                <span class="brand-sub">Security · Embedded · Dev</span>
              </span>
            </a>

            <div class="topbar-spacer"></div>

            <div class="topbar-right" aria-hidden="true">
              <span class="pill">Blog</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Mobile overlay (click to close) -->
    <label class="overlay" for="sidebar-toggle" aria-label="메뉴 닫기"></label>

    <div class="shell">
      <aside class="sidebar" aria-label="사이드바">
        <Sidebar posts={allPosts} />
      </aside>

      <div class="main">
        <div class="container">
          <slot />
        </div>
      </div>
    </div>

    <script is:inline>
      (() => {
        const KEY = "pingu.sidebar_open";
        const cb = document.getElementById("sidebar-toggle");
        if (!(cb instanceof HTMLInputElement)) return;

        const mq = window.matchMedia("(min-width: 861px)");
        const saved = localStorage.getItem(KEY);
        if (saved === null) {
          cb.checked = mq.matches;
        } else {
          cb.checked = saved === "1";
        }

        cb.addEventListener("change", () => {
          localStorage.setItem(KEY, cb.checked ? "1" : "0");
        });

        // If there's no saved preference, follow breakpoint changes.
        mq.addEventListener?.("change", (e) => {
          if (localStorage.getItem(KEY) === null) cb.checked = e.matches;
        });
      })();
    </script>
  </body>
</html>
